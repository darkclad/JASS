{% extends "base.html" %}

{% block title %}{{ job.title }} - JASS{% endblock %}

{% block extra_css %}
<style>
    .job-description {
        max-height: 500px;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .job-description h1, .job-description h2, .job-description h3 {
        font-size: 1.1rem;
        font-weight: bold;
        margin-top: 1rem;
    }
    .job-description ul {
        margin-bottom: 0.5rem;
    }
    .job-meta-badge {
        font-size: 0.85rem;
        padding: 0.4em 0.8em;
    }
    .skill-badge {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('jobs') }}">Saved Jobs</a></li>
            <li class="breadcrumb-item active">{{ job.title }}</li>
        </ol>
    </nav>
</div>

<div class="row">
    <!-- Job Info -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ job.title }}</h5>
                <span class="badge status-{{ job.status }}">{{ job.status }}</span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Company:</strong> {{ job.company }}
                    </div>
                    <div class="col-md-6">
                        <strong>Location:</strong> {{ job.location or '-' }}
                    </div>
                </div>

                <!-- Parsed Job Info -->
                <div class="mb-3">
                    {% if job.salary_text %}
                    <span class="badge bg-success job-meta-badge me-2">
                        <i class="bi bi-currency-dollar"></i> {{ job.salary_text }}
                    </span>
                    {% endif %}
                    {% if job.is_remote == true %}
                    <span class="badge bg-info job-meta-badge me-2">
                        <i class="bi bi-house-door"></i> Remote
                    </span>
                    {% elif job.is_remote == false %}
                    <span class="badge bg-secondary job-meta-badge me-2">
                        <i class="bi bi-building"></i> On-site
                    </span>
                    {% endif %}
                    {% if job.experience_years %}
                    <span class="badge bg-primary job-meta-badge me-2">
                        <i class="bi bi-clock-history"></i> {{ job.experience_years }} years
                    </span>
                    {% endif %}
                    {% if job.source and job.source != 'greenhouse' %}
                    <span class="badge bg-light text-dark job-meta-badge">
                        <i class="bi bi-link-45deg"></i> {{ job.source|title }}
                    </span>
                    {% endif %}
                </div>

                {% if job.skills %}
                <div class="mb-3">
                    <strong class="small text-muted">Skills:</strong>
                    {% for skill in job.skills|fromjson if job.skills %}
                    <span class="badge bg-light text-dark skill-badge">{{ skill }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                {% if job.department %}
                <div class="mb-3">
                    <strong>Department:</strong> {{ job.department }}
                </div>
                {% endif %}

                {% if job.url %}
                <div class="mb-3">
                    <a href="{{ job.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-box-arrow-up-right"></i> View Original Posting
                    </a>
                </div>
                {% endif %}

                <hr>

                <h6>Job Description</h6>
                <div class="job-description">
                    {% if job.source == 'greenhouse' %}
                    {{ html_description|safe }}
                    {% else %}
                    <pre style="white-space: pre-wrap; font-family: inherit;">{{ job.description or 'No description provided.' }}</pre>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Panel -->
    <div class="col-lg-4">
        <!-- Generate Documents -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-magic"></i> AI Tailoring
            </div>
            <div class="card-body">
                {% if not master_resume %}
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i>
                    No master resume found. <a href="{{ url_for('resume') }}">Create one first</a>.
                </div>
                {% elif not ai_config or not ai_config.api_key %}
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i>
                    AI not configured. <a href="{{ url_for('settings') }}">Configure API key</a>.
                </div>
                {% else %}
                <p class="small text-muted">
                    Using: <strong>{{ master_resume.name }}</strong><br>
                    AI: <strong>{{ ai_config.provider }} / {{ ai_config.model_name }}</strong>
                </p>
                {% endif %}

                <form action="{{ url_for('tailor_job', id=job.id) }}" method="POST" id="tailorForm">
                    <button type="submit" class="btn btn-primary w-100" id="tailorBtn"
                            {% if not master_resume or not ai_config or not ai_config.api_key %}disabled{% endif %}>
                        <span class="btn-text"><i class="bi bi-magic"></i> Generate Tailored Resume & Cover Letter</span>
                        <span class="spinner-border" role="status"></span>
                    </button>
                </form>

                {% if job.application %}
                <hr>
                <a href="{{ url_for('application_detail', id=job.application.id) }}" class="btn btn-success w-100">
                    <i class="bi bi-file-earmark-check"></i> View Application
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning"></i> Actions
            </div>
            <div class="card-body">
                {% if job.url %}
                <a href="{{ job.url }}" target="_blank" class="btn btn-outline-primary w-100 mb-2">
                    <i class="bi bi-box-arrow-up-right"></i> Open Job Posting
                </a>
                {% endif %}

                {% if job.status != 'applied' %}
                <form action="{{ url_for('mark_applied', id=job.id) }}" method="POST">
                    <button type="submit" class="btn btn-success w-100 mb-2">
                        <i class="bi bi-check2-circle"></i> Mark as Applied
                    </button>
                </form>
                {% else %}
                <div class="alert alert-success mb-2 py-2 text-center">
                    <i class="bi bi-check2-circle"></i> Applied
                    {% if job.applied_at %}
                    <br><small>{{ job.applied_at.strftime('%Y-%m-%d') }}</small>
                    {% endif %}
                </div>
                {% endif %}

                <form action="{{ url_for('delete_job', id=job.id) }}" method="POST"
                      onsubmit="return confirm('Delete this job?')">
                    <button type="submit" class="btn btn-outline-danger w-100">
                        <i class="bi bi-trash"></i> Delete Job
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('tailorForm')?.addEventListener('submit', function() {
    const btn = document.getElementById('tailorBtn');
    setLoading(btn, true);
});
</script>
{% endblock %}
