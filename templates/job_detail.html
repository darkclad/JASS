{% extends "base.html" %}

{% block title %}{{ job.title }} - JASS{% endblock %}

{% block extra_css %}
<style>
    .job-description {
        max-height: 500px;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .job-description h1, .job-description h2, .job-description h3 {
        font-size: 1.1rem;
        font-weight: bold;
        margin-top: 1rem;
    }
    .job-description ul {
        margin-bottom: 0.5rem;
    }
    .job-meta-badge {
        font-size: 0.85rem;
        padding: 0.4em 0.8em;
    }
    .skill-badge {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('jobs') }}">Saved Jobs</a></li>
            <li class="breadcrumb-item active">{{ job.title }}</li>
        </ol>
    </nav>
</div>

<div class="row">
    <!-- Job Info -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ job.title }}</h5>
                <span class="badge status-{{ job.status }}">{{ job.status }}</span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Company:</strong> {{ job.company }}
                    </div>
                    <div class="col-md-6">
                        <strong>Location:</strong> {{ job.location or '-' }}
                    </div>
                </div>

                <!-- Parsed Job Info -->
                <div class="mb-3">
                    {% if job.salary_text %}
                    <span class="badge bg-success job-meta-badge me-2">
                        <i class="bi bi-currency-dollar"></i> {{ job.salary_text }}
                    </span>
                    {% endif %}
                    {% if job.is_remote == true %}
                    <span class="badge bg-info job-meta-badge me-2">
                        <i class="bi bi-house-door"></i> Remote
                    </span>
                    {% elif job.is_remote == false %}
                    <span class="badge bg-secondary job-meta-badge me-2">
                        <i class="bi bi-building"></i> On-site
                    </span>
                    {% endif %}
                    {% if job.posted_at %}
                    <span class="badge bg-primary job-meta-badge me-2" title="Posted {{ job.posted_at.strftime('%Y-%m-%d') }}">
                        <i class="bi bi-calendar-event"></i> {{ job_age }}
                    </span>
                    {% endif %}
                    {% if job.source and job.source != 'greenhouse' %}
                    <span class="badge bg-light text-dark job-meta-badge">
                        <i class="bi bi-link-45deg"></i> {{ job.source|title }}
                    </span>
                    {% endif %}
                </div>

                {% if job.skills %}
                <div class="mb-3">
                    <strong class="small text-muted">Skills:</strong>
                    {% for skill in job.skills|fromjson if job.skills %}
                    <span class="badge bg-light text-dark skill-badge">{{ skill }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                {% if job.department %}
                <div class="mb-3">
                    <strong>Department:</strong> {{ job.department }}
                </div>
                {% endif %}

                {% if job.url %}
                <div class="mb-3">
                    <a href="{{ job.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-box-arrow-up-right"></i> View Original Posting
                    </a>
                </div>
                {% endif %}

                <hr>

                <h6>Job Description</h6>
                <div class="job-description">
                    {% if job.source == 'greenhouse' %}
                    {{ html_description|safe }}
                    {% else %}
                    <pre style="white-space: pre-wrap; font-family: inherit;">{{ job.description or 'No description provided.' }}</pre>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Status -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-flag"></i> Status
            </div>
            <div class="card-body">
                {% if job.status == 'applied' and job.applied_at %}
                <p class="mb-0">Applied on {{ job.applied_at.strftime('%Y-%m-%d') }}</p>
                {% elif job.status == 'ready' %}
                <p class="mb-0">Ready</p>
                {% else %}
                <p class="mb-0">Saved on {{ job.created_at.strftime('%Y-%m-%d') }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Details -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Details
            </div>
            <div class="card-body small">
                <p class="mb-1"><strong>Source:</strong> {{ job.source|title if job.source else '-' }}</p>
                <p class="mb-1"><strong>Added:</strong> {{ job.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                {% if job.posted_at %}
                <p class="mb-1"><strong>Posted:</strong> {{ job.posted_at.strftime('%Y-%m-%d') }}</p>
                {% endif %}
            </div>
        </div>

        {% if not (job.application and job.application.status == 'applied') %}
        <!-- AI Tailoring (hide for applied applications) -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-magic"></i> AI Tailoring
            </div>
            <div class="card-body">
                {% if not master_resume %}
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i>
                    No master resume found. <a href="{{ url_for('resume') }}">Create one first</a>.
                </div>
                {% elif not ai_config or (ai_config.provider != 'claude-cli' and not ai_config.api_key) %}
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i>
                    AI not configured. <a href="{{ url_for('settings') }}">Configure AI settings</a>.
                </div>
                {% else %}
                <p class="small text-muted">
                    Using: <strong>{{ master_resume.name }}</strong><br>
                    AI: <strong>{{ ai_config.provider }} / {{ ai_config.model_name }}</strong>
                </p>
                {% endif %}

                <button type="button" class="btn btn-primary w-100 mb-2" id="tailorResumeBtn"
                        {% if not master_resume or not ai_config or (ai_config.provider != 'claude-cli' and not ai_config.api_key) %}disabled{% endif %}
                        data-tailor-url="{{ url_for('tailor_resume_stream', id=job.id) }}">
                    <span class="btn-text"><i class="bi bi-file-person"></i> Generate Tailored Resume</span>
                    <span class="btn-status" style="display: none;"></span>
                    <span class="spinner-border" role="status"></span>
                </button>
                <button type="button" class="btn btn-primary w-100" id="tailorCoverLetterBtn"
                        {% if not master_resume or not ai_config or (ai_config.provider != 'claude-cli' and not ai_config.api_key) or not job.application or not job.application.resume_md %}disabled{% endif %}
                        data-tailor-url="{{ url_for('tailor_cover_letter_stream', id=job.id) }}"
                        {% if not job.application or not job.application.resume_md %}title="Generate a resume first"{% endif %}>
                    <span class="btn-text"><i class="bi bi-envelope"></i> Generate Cover Letter</span>
                    <span class="btn-status" style="display: none;"></span>
                    <span class="spinner-border" role="status"></span>
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-lightning"></i> Actions
            </div>
            <div class="card-body">
                {% if job.application %}
                <a href="{{ url_for('application_detail', id=job.application.id) }}" class="btn btn-success w-100 mb-2">
                    <i class="bi bi-file-earmark-check"></i> View Application
                </a>
                {% endif %}

                {% if job.url %}
                <a href="{{ job.url }}" target="_blank" class="btn btn-success w-100 mb-2">
                    <i class="bi bi-box-arrow-up-right"></i> Open Job Posting
                </a>
                {% endif %}

                {% if job.status != 'applied' %}
                <form action="{{ url_for('mark_applied', id=job.id) }}" method="POST">
                    <button type="submit" class="btn btn-success w-100 mb-2">
                        <i class="bi bi-check2-circle"></i> Mark as Applied
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-exclamation-triangle"></i> Danger Zone
            </div>
            <div class="card-body">
                <form action="{{ url_for('delete_job', id=job.id) }}" method="POST"
                      onsubmit="return confirm('Delete this job?')">
                    <button type="submit" class="btn btn-outline-danger w-100">
                        <i class="bi bi-trash"></i> Delete Job
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function setupTailorButton(btnId) {
    document.getElementById(btnId)?.addEventListener('click', function() {
        const btn = this;
        const url = btn.dataset.tailorUrl;
        const btnText = btn.querySelector('.btn-text');
        const btnStatus = btn.querySelector('.btn-status');
        const spinner = btn.querySelector('.spinner-border');

        // Show loading state with status text
        btn.disabled = true;
        btn.classList.add('loading');
        document.body.classList.add('loading');
        btnText.style.display = 'none';
        btnStatus.style.display = 'inline';
        spinner.style.display = 'inline-block';

        // Disable the other button too
        const otherBtn = btnId === 'tailorResumeBtn'
            ? document.getElementById('tailorCoverLetterBtn')
            : document.getElementById('tailorResumeBtn');
        if (otherBtn) otherBtn.disabled = true;

        // Start timer (resets on each stage)
        let stageStartTime = Date.now();
        let currentStatus = 'Starting...';
        let timerInterval;

        function updateStatus() {
            const elapsed = Math.floor((Date.now() - stageStartTime) / 1000);
            btnStatus.innerHTML = '<i class="bi bi-hourglass-split"></i> ' + currentStatus + ' (' + elapsed + 's)';
        }

        updateStatus();
        timerInterval = setInterval(updateStatus, 1000);

        // Connect to SSE endpoint
        const eventSource = new EventSource(url);

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.error) {
                clearInterval(timerInterval);
                eventSource.close();
                alert('Error: ' + data.error);
                // Reset button
                btn.disabled = false;
                btn.classList.remove('loading');
                document.body.classList.remove('loading');
                btnText.style.display = 'inline';
                btnStatus.style.display = 'none';
                spinner.style.display = 'none';
                if (otherBtn && !otherBtn.hasAttribute('title')) otherBtn.disabled = false;
                return;
            }

            if (data.status) {
                currentStatus = data.status;
                stageStartTime = Date.now();  // Reset timer for new stage
                updateStatus();
            }

            if (data.redirect) {
                clearInterval(timerInterval);
                eventSource.close();
                window.location.href = data.redirect;
            }
        };

        eventSource.onerror = function() {
            clearInterval(timerInterval);
            eventSource.close();
            alert('Connection lost. Please try again.');
            // Reset button
            btn.disabled = false;
            btn.classList.remove('loading');
            document.body.classList.remove('loading');
            btnText.style.display = 'inline';
            btnStatus.style.display = 'none';
            spinner.style.display = 'none';
            if (otherBtn && !otherBtn.hasAttribute('title')) otherBtn.disabled = false;
        };
    });
}

setupTailorButton('tailorResumeBtn');
setupTailorButton('tailorCoverLetterBtn');
</script>
{% endblock %}
