{% extends "base.html" %}

{% block title %}Add Job - JASS{% endblock %}

{% block extra_css %}
<style>
    .job-description {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
        min-height: 50vh;
        height: calc(100vh - 550px);
        resize: vertical;
    }
    .parsed-info {
        display: none;
    }
    .parsed-info.show {
        display: block;
    }
    .extracted-hint a {
        text-decoration: underline;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb" class="mb-0">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('jobs') }}">Jobs</a></li>
                <li class="breadcrumb-item active">Add Job</li>
            </ol>
        </nav>
    </div>
    <div>
        <button type="submit" form="addJobForm" class="btn btn-success me-2" id="submitBtnTop">
            <span class="btn-text"><i class="bi bi-plus-circle"></i> Add Job</span>
            <span class="spinner-border" role="status"></span>
        </button>
        <a href="{{ url_for('jobs') }}" class="btn btn-outline-secondary">Cancel</a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-plus-circle"></i> Add Job Manually
            </div>
            <div class="card-body">
                <form action="{{ url_for('add_job') }}" method="POST" id="addJobForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Job Title <span class="text-danger">*</span></label>
                            <input type="text" name="title" id="titleInput" class="form-control" required
                                   placeholder="e.g., Senior Software Engineer">
                            <small class="text-muted extracted-hint" id="titleHint" style="display: none;"></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Company <span class="text-danger">*</span></label>
                            <input type="text" name="company" id="companyInput" class="form-control" required
                                   placeholder="e.g., Acme Corp">
                            <small class="text-muted extracted-hint" id="companyHint" style="display: none;"></small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Location</label>
                            <input type="text" name="location" id="locationInput" class="form-control"
                                   placeholder="e.g., San Diego, CA or Remote">
                            <small class="text-muted extracted-hint" id="locationHint" style="display: none;"></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Source</label>
                            <select name="source" id="sourceSelect" class="form-select">
                                <option value="linkedin">LinkedIn</option>
                                <option value="indeed">Indeed</option>
                                <option value="glassdoor">Glassdoor</option>
                                <option value="company_site">Company Website</option>
                                <option value="referral">Referral</option>
                                <option value="manual" selected>Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Job URL (optional)</label>
                        <input type="url" name="url" class="form-control"
                               placeholder="https://...">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Job Description</label>
                        <textarea name="description" class="form-control job-description" id="jobDescription"
                                  placeholder="Paste the job description here..."></textarea>
                        <div class="form-text">
                            Paste the full job description. Salary, experience requirements, and skills will be automatically extracted.
                        </div>
                    </div>

                    <!-- Parsed Info Preview -->
                    <div class="parsed-info mb-3" id="parsedInfo">
                        <div class="alert alert-info">
                            <strong><i class="bi bi-magic"></i> Auto-detected:</strong>
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <small class="text-muted">Salary:</small>
                                    <span id="parsedSalary">-</span>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Remote:</small>
                                    <span id="parsedRemote">-</span>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Posted:</small>
                                    <span id="parsedPosted">-</span>
                                </div>
                            </div>
                            <div class="mt-2" id="parsedSkillsRow" style="display: none;">
                                <small class="text-muted">Skills:</small>
                                <span id="parsedSkills"></span>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Tips
            </div>
            <div class="card-body">
                <p class="small mb-2">
                    <strong>Paste the job description first!</strong> The system will automatically extract:
                </p>
                <ul class="small mb-0">
                    <li><strong>Job title</strong> and <strong>company name</strong></li>
                    <li>Salary range</li>
                    <li>Remote/hybrid status</li>
                    <li>Years of experience required</li>
                    <li>Technical skills mentioned</li>
                </ul>
                <hr>
                <p class="small mb-0">
                    <strong>Sources:</strong> Select where you found the job to track which platforms are most effective.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let parseTimeout;

document.getElementById('jobDescription')?.addEventListener('input', function() {
    clearTimeout(parseTimeout);
    parseTimeout = setTimeout(parseDescription, 500);
});

async function parseDescription() {
    const text = document.getElementById('jobDescription').value;
    const title = document.getElementById('titleInput').value;
    const location = document.getElementById('locationInput').value;

    if (!text || text.length < 50) {
        document.getElementById('parsedInfo').classList.remove('show');
        document.getElementById('titleHint').style.display = 'none';
        document.getElementById('companyHint').style.display = 'none';
        document.getElementById('locationHint').style.display = 'none';
        return;
    }

    try {
        const response = await fetch('/jobs/parse', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description: text, title: title, location: location })
        });
        const parsed = await response.json();

        // Update parsed info preview
        document.getElementById('parsedSalary').textContent = parsed.salary_text || '-';
        document.getElementById('parsedRemote').textContent = parsed.is_remote !== null ?
            (parsed.is_remote ? 'Yes' : 'No') : '-';

        // Format posted date
        if (parsed.posted_at) {
            const posted = new Date(parsed.posted_at);
            const now = new Date();
            const diffMs = now - posted;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            let postedText;
            if (diffDays === 0) {
                postedText = 'Today';
            } else if (diffDays === 1) {
                postedText = '1 day ago';
            } else if (diffDays < 7) {
                postedText = `${diffDays} days ago`;
            } else if (diffDays < 14) {
                postedText = '1 week ago';
            } else if (diffDays < 30) {
                postedText = `${Math.floor(diffDays / 7)} weeks ago`;
            } else {
                postedText = posted.toLocaleDateString();
            }
            document.getElementById('parsedPosted').textContent = postedText;
        } else {
            document.getElementById('parsedPosted').textContent = '-';
        }

        if (parsed.skills && parsed.skills.length > 0) {
            document.getElementById('parsedSkills').textContent = parsed.skills.join(', ');
            document.getElementById('parsedSkillsRow').style.display = 'block';
        } else {
            document.getElementById('parsedSkillsRow').style.display = 'none';
        }

        document.getElementById('parsedInfo').classList.add('show');

        // Auto-select source based on detected format
        if (parsed.source_format === 'linkedin') {
            document.getElementById('sourceSelect').value = 'linkedin';
            // Replace description with cleaned version (header removed)
            if (parsed.cleaned_description) {
                document.getElementById('jobDescription').value = parsed.cleaned_description;
            }
        }

        // Auto-fill title if empty and extracted
        const titleInput = document.getElementById('titleInput');
        const titleHint = document.getElementById('titleHint');
        if (parsed.extracted_title) {
            if (!titleInput.value) {
                titleInput.value = parsed.extracted_title;
                titleHint.style.display = 'none';
            } else if (titleInput.value !== parsed.extracted_title) {
                titleHint.innerHTML = `Detected: <a href="#" onclick="document.getElementById('titleInput').value='${parsed.extracted_title.replace(/'/g, "\\'")}'; this.parentElement.style.display='none'; return false;">${parsed.extracted_title}</a>`;
                titleHint.style.display = 'block';
            }
        } else {
            titleHint.style.display = 'none';
        }

        // Auto-fill company if empty and extracted
        const companyInput = document.getElementById('companyInput');
        const companyHint = document.getElementById('companyHint');
        if (parsed.extracted_company) {
            if (!companyInput.value) {
                companyInput.value = parsed.extracted_company;
                companyHint.style.display = 'none';
            } else if (companyInput.value !== parsed.extracted_company) {
                companyHint.innerHTML = `Detected: <a href="#" onclick="document.getElementById('companyInput').value='${parsed.extracted_company.replace(/'/g, "\\'")}'; this.parentElement.style.display='none'; return false;">${parsed.extracted_company}</a>`;
                companyHint.style.display = 'block';
            }
        } else {
            companyHint.style.display = 'none';
        }

        // Auto-fill location if empty and extracted
        const locationInput = document.getElementById('locationInput');
        const locationHint = document.getElementById('locationHint');
        if (parsed.extracted_location) {
            if (!locationInput.value) {
                locationInput.value = parsed.extracted_location;
                locationHint.style.display = 'none';
            } else if (locationInput.value !== parsed.extracted_location) {
                locationHint.innerHTML = `Detected: <a href="#" onclick="document.getElementById('locationInput').value='${parsed.extracted_location.replace(/'/g, "\\'")}'; this.parentElement.style.display='none'; return false;">${parsed.extracted_location}</a>`;
                locationHint.style.display = 'block';
            }
        } else {
            locationHint.style.display = 'none';
        }

    } catch (err) {
        console.error('Parse error:', err);
    }
}

document.getElementById('addJobForm')?.addEventListener('submit', function() {
    setLoading(document.getElementById('submitBtnTop'), true);
});
</script>
{% endblock %}
