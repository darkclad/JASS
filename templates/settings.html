{% extends "base.html" %}

{% block title %}Settings - JASS{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="bi bi-gear"></i> Settings</h1>

<div class="row">
    <div class="col-lg-6">
        <!-- AI Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-robot"></i> AI Configuration
            </div>
            <div class="card-body">
                <form action="{{ url_for('save_settings') }}" method="POST">
                    <div class="mb-3">
                        <label class="form-label">AI Provider</label>
                        <select name="provider" class="form-select" id="providerSelect">
                            <option value="claude" {% if active_config and active_config.provider == 'claude' %}selected{% endif %}>
                                Claude (Anthropic)
                            </option>
                            <option value="openai" {% if active_config and active_config.provider == 'openai' %}selected{% endif %}>
                                OpenAI (GPT-4)
                            </option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">API Key</label>
                        <input type="password" name="api_key" class="form-control"
                               value="{{ active_config.api_key if active_config else '' }}"
                               placeholder="sk-... or your API key">
                        <div class="form-text">Your API key is stored locally and never shared.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Model</label>
                        <select name="model_name" class="form-select" id="modelSelect">
                            <!-- Claude models -->
                            <optgroup label="Claude" class="claude-models">
                                <option value="claude-sonnet-4-20250514" {% if active_config and active_config.model_name == 'claude-sonnet-4-20250514' %}selected{% endif %}>
                                    Claude Sonnet 4 (Recommended)
                                </option>
                                <option value="claude-3-5-sonnet-20241022" {% if active_config and active_config.model_name == 'claude-3-5-sonnet-20241022' %}selected{% endif %}>
                                    Claude 3.5 Sonnet
                                </option>
                                <option value="claude-3-haiku-20240307" {% if active_config and active_config.model_name == 'claude-3-haiku-20240307' %}selected{% endif %}>
                                    Claude 3 Haiku (Faster/Cheaper)
                                </option>
                            </optgroup>
                            <!-- OpenAI models -->
                            <optgroup label="OpenAI" class="openai-models">
                                <option value="gpt-4" {% if active_config and active_config.model_name == 'gpt-4' %}selected{% endif %}>
                                    GPT-4
                                </option>
                                <option value="gpt-4-turbo" {% if active_config and active_config.model_name == 'gpt-4-turbo' %}selected{% endif %}>
                                    GPT-4 Turbo
                                </option>
                                <option value="gpt-3.5-turbo" {% if active_config and active_config.model_name == 'gpt-3.5-turbo' %}selected{% endif %}>
                                    GPT-3.5 Turbo (Cheaper)
                                </option>
                            </optgroup>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Save Settings
                    </button>
                </form>
            </div>
        </div>

        <!-- Test Connection -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-plug"></i> Test Connection
            </div>
            <div class="card-body">
                {% if active_config and active_config.api_key %}
                <p class="text-muted small">
                    Current: <strong>{{ active_config.provider }}</strong> / <strong>{{ active_config.model_name }}</strong>
                </p>
                <button type="button" class="btn btn-outline-primary" id="testBtn" onclick="testConnection()">
                    <span class="btn-text"><i class="bi bi-check-circle"></i> Test API Connection</span>
                    <span class="spinner-border" role="status"></span>
                </button>
                <div id="testResult" class="mt-3"></div>
                {% else %}
                <p class="text-muted">Configure your API key above to test the connection.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <!-- Instructions -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Getting API Keys
            </div>
            <div class="card-body">
                <h6>Claude (Anthropic)</h6>
                <ol class="small">
                    <li>Go to <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></li>
                    <li>Sign up or log in</li>
                    <li>Navigate to API Keys</li>
                    <li>Create a new key and copy it here</li>
                </ol>

                <hr>

                <h6>OpenAI</h6>
                <ol class="small">
                    <li>Go to <a href="https://platform.openai.com/" target="_blank">platform.openai.com</a></li>
                    <li>Sign up or log in</li>
                    <li>Go to API Keys in settings</li>
                    <li>Create a new key and copy it here</li>
                </ol>
            </div>
        </div>

        <!-- Greenhouse Boards -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-building"></i> Default Company Boards</span>
                {% if boards != default_boards %}
                <span class="badge bg-info">Custom</span>
                {% endif %}
            </div>
            <div class="card-body">
                <p class="small text-muted">
                    These Greenhouse boards are searched by default. One board per line.
                </p>
                <form action="{{ url_for('save_boards') }}" method="POST">
                    <div class="mb-3">
                        <textarea name="boards" class="form-control font-monospace" rows="8"
                                  style="font-size: 0.85rem;" required>{% for board in boards %}{{ board }}{% if not loop.last %}
{% endif %}{% endfor %}</textarea>
                        <div class="form-text">Enter one board name per line (e.g., sentinellabs, cloudflare)</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="bi bi-save"></i> Save Boards
                        </button>
                        {% if boards != default_boards %}
                        <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="if(confirm('Restore default boards?')) document.getElementById('restoreForm').submit()">
                            <i class="bi bi-arrow-counterclockwise"></i> Restore Defaults
                        </button>
                        {% endif %}
                    </div>
                </form>
                <form id="restoreForm" action="{{ url_for('restore_default_boards') }}" method="POST" style="display: none;"></form>
                <hr>
                <p class="small text-muted mb-0">
                    To find more boards, check company career pages for Greenhouse URLs like
                    <code>boards.greenhouse.io/BOARD_NAME</code>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Show/hide model options based on provider
document.getElementById('providerSelect')?.addEventListener('change', function() {
    const provider = this.value;
    document.querySelectorAll('#modelSelect optgroup').forEach(g => {
        g.style.display = g.classList.contains(provider + '-models') ? '' : 'none';
    });
    // Select first option of visible group
    const visibleGroup = document.querySelector(`#modelSelect optgroup.${provider}-models`);
    if (visibleGroup) {
        visibleGroup.querySelector('option').selected = true;
    }
});

async function testConnection() {
    const btn = document.getElementById('testBtn');
    const result = document.getElementById('testResult');

    setLoading(btn, true);
    result.innerHTML = '';

    try {
        const response = await fetch('/settings/test', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            result.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> Connection successful!</div>';
        } else {
            result.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ${data.error}</div>`;
        }
    } catch (err) {
        result.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Error: ${err.message}</div>`;
    }

    setLoading(btn, false);
}
</script>
{% endblock %}
